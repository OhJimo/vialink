<div class="dashboard-container">
  <div class="dashboard-header">
    <h1 class="page-title">내 대시보드</h1>
    <div class="user-info">
      <span class="user-email"><%= current_user.email %></span>
      <span class="user-plan badge-<%= current_user.plan %>">
        <%= current_user.plan == 'free' ? 'FREE' : current_user.plan == 'pro' ? 'PRO' : 'LIFETIME' %>
      </span>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">이번 달 생성 링크</div>
      <div class="stat-value"><%= @current_month_links_count %> / <%= @monthly_limit %></div>
      <div class="stat-progress">
        <div class="progress-bar" style="width: <%= (@current_month_links_count.to_f / @monthly_limit * 100).round %>%"></div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-label">남은 링크</div>
      <div class="stat-value <%= @remaining_links <= 0 ? 'text-danger' : '' %>"><%= @remaining_links %>개</div>
    </div>

    <div class="stat-card">
      <div class="stat-label">전체 링크</div>
      <div class="stat-value"><%= @links.count %>개</div>
    </div>

    <div class="stat-card">
      <div class="stat-label">총 클릭 수</div>
      <div class="stat-value"><%= @links.sum(:click_count) %>회</div>
    </div>
  </div>

  <div class="links-section">
    <div class="links-section-header">
      <h2>내 링크 목록</h2>
      <div class="links-header-right">
        <% unless @links.empty? %>
          <select id="sort-select" class="sort-select">
            <option value="created_at-desc">생성일 (최신순)</option>
            <option value="created_at-asc">생성일 (오래된순)</option>
            <option value="click_count-desc">클릭 수 (높은순)</option>
            <option value="click_count-asc">클릭 수 (낮은순)</option>
            <option value="expires_at-asc">만료일 (가까운순)</option>
            <option value="expires_at-desc">만료일 (먼순)</option>
          </select>
        <% end %>
        <%= link_to new_link_path, class: 'btn-header' do %>
          <span class="btn-icon">+</span>
          <span>새 링크 만들기</span>
        <% end %>
      </div>
    </div>

    <% if @links.empty? %>
      <div class="empty-state">
        <p>아직 생성된 링크가 없습니다.</p>
      </div>
    <% else %>
      <div class="links-table" id="links-table">
        <table>
          <thead>
            <tr>
              <th>짧은 링크</th>
              <th>원본 URL</th>
              <th>클릭 수</th>
              <th>생성일</th>
              <th>만료일</th>
              <th>상태</th>
              <th>동작</th>
            </tr>
          </thead>
          <tbody>
            <% @links.each do |link| %>
              <tr class="<%= 'expired-row' if link.expired? %>">
                <td class="short-link-cell">
                  <div class="short-link-container">
                    <a href="<%= link_url(link.code) %>" target="_blank" rel="noopener" class="short-link">
                      <%= link_url(link.code) %>
                    </a>
                    <button class="btn-icon-copy"
                            data-url="<%= link_url(link.code) %>"
                            onclick="copyToClipboard(this.dataset.url); return false;"
                            title="링크 복사">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                      </svg>
                    </button>
                  </div>
                </td>
                <td class="url-cell">
                  <a href="<%= link.original_url %>" target="_blank" rel="noopener" class="original-url">
                    <%= truncate(link.original_url, length: 50) %>
                  </a>
                </td>
                <td class="text-center"><%= link.click_count %></td>
                <td><%= link.created_at.strftime('%Y-%m-%d %H:%M') %></td>
                <td>
                  <% if link.expires_at %>
                    <%= link.expires_at.strftime('%Y-%m-%d') %>
                  <% else %>
                    <span class="text-success">영구</span>
                  <% end %>
                </td>
                <td>
                  <% if link.expired? %>
                    <span class="badge-danger">만료됨</span>
                  <% else %>
                    <span class="badge-success">활성</span>
                  <% end %>
                </td>
                <td>
                  <%= button_to '삭제', link_path(link), method: :delete,
                      data: { confirm: '정말 삭제하시겠습니까?' },
                      class: 'btn-small btn-danger' %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
  </div>
</div>

<script>
function copyToClipboard(url) {
  navigator.clipboard.writeText(url).then(function() {
    alert('링크가 클립보드에 복사되었습니다!');
  }, function(err) {
    console.error('복사 실패:', err);
  });
}

// 정렬 기능
document.addEventListener('DOMContentLoaded', function() {
  const sortSelect = document.getElementById('sort-select');
  if (!sortSelect) return;

  sortSelect.addEventListener('change', function() {
    const [field, order] = this.value.split('-');
    sortTable(field, order);
  });
});

function sortTable(field, order) {
  const table = document.querySelector('#links-table table tbody');
  const rows = Array.from(table.querySelectorAll('tr'));

  rows.sort((a, b) => {
    let aValue, bValue;

    switch(field) {
      case 'click_count':
        aValue = parseInt(a.cells[2].textContent.trim());
        bValue = parseInt(b.cells[2].textContent.trim());
        break;
      case 'created_at':
        aValue = new Date(a.cells[3].textContent.trim());
        bValue = new Date(b.cells[3].textContent.trim());
        break;
      case 'expires_at':
        const aText = a.cells[4].textContent.trim();
        const bText = b.cells[4].textContent.trim();
        // "영구"는 가장 나중으로
        if (aText === '영구') aValue = new Date('2099-12-31');
        else aValue = new Date(aText);
        if (bText === '영구') bValue = new Date('2099-12-31');
        else bValue = new Date(bText);
        break;
    }

    if (order === 'asc') {
      return aValue > bValue ? 1 : -1;
    } else {
      return aValue < bValue ? 1 : -1;
    }
  });

  // 테이블 다시 그리기
  rows.forEach(row => table.appendChild(row));
}
</script>
